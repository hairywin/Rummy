<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Rummy 500 üÉè ‚Äî Scorekeeper</title>
<style>
  :root{
    --bg:#09102a; --ink:#eef3ff; --muted:#a8b7de; --panel:#12183b; --panel2:#0d1331;
    --line:#273579; --accent:#5dd39e; --warn:#ffd166; --danger:#ff6b6b;
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%; max-width:100%; overflow-x:hidden}
  body{
    margin:0;
    padding:14px max(14px, env(safe-area-inset-right)) 14px max(14px, env(safe-area-inset-left));
    background:
      radial-gradient(120% 120% at 20% -10%, #1d265a 0%, transparent 60%),
      radial-gradient(120% 120% at 80% -10%, #1b2a66 0%, transparent 60%),
      linear-gradient(180deg,var(--panel2),#070b1e 70%);
    color:var(--ink);
    font:600 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }
  .wrap{width:min(1300px,100%); margin-inline:auto; display:grid; gap:12px}

  header.card{
    display:flex; gap:10px; align-items:center; justify-content:space-between; padding:12px 14px;
    background:linear-gradient(180deg,#121a3e,#0f1736); border:1px solid var(--line); border-radius:16px; box-shadow:0 8px 24px #0006;
  }
  .title{font-size:22px; display:flex; align-items:center; gap:8px}
  .cluster{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .pill{padding:6px 10px; border-radius:999px; background:#0d1740; border:1px solid var(--line); color:var(--ink); font-weight:800}
  input, button{
    background:#0d1740; color:var(--ink); border:1px solid var(--line); border-radius:12px; padding:8px 10px; font-weight:700;
  }
  input[type="number"]{width:90px; max-width:100%}
  input[type="text"]{min-width:140px; max-width:100%}
  button{cursor:pointer}
  button:hover{filter:brightness(1.07)}
  button:active{transform:translateY(1px)}

  .grid{display:grid; gap:12px; grid-template-columns:.65fr 1.35fr; align-items:start}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .players{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:12px; box-shadow:0 6px 18px #0005}
  .player{position:relative; overflow:hidden}
  .player::before{content:"‚ô†Ô∏è"; position:absolute; right:8px; top:6px; opacity:.12; font-size:22px; pointer-events:none}
  .player.leader{outline:2px solid var(--accent); box-shadow:0 0 0 3px #5dd39e40 inset}
  .player header{display:flex; align-items:center; gap:12px; margin-bottom:8px}
  .avatar{
    position:relative; width:52px; height:52px; border-radius:50%; display:grid; place-items:center; font-size:26px;
    background:radial-gradient(100% 100% at 30% 20%, #62d7a9 0%, #5a8cf5 40%, #a98cfa 100%);
    border:2px solid #0c1240; color:#fff; text-shadow:0 1px 0 #0008; flex:0 0 52px;
  }
  .avatar .chip{
    position:absolute; right:-6px; bottom:-6px; font:800 11px/1 ui-monospace,SFMono-Regular,Consolas,monospace;
    background:#0b153a; border:1px solid #22306b; color:#fff; padding:4px 6px; border-radius:999px;
  }
  .nameBlock{display:flex; flex-direction:column; min-width:0}
  .nameBlock input{
    font-size:18px; font-weight:900; letter-spacing:.2px; background:#0b153a; border-color:#22306b; padding:6px 10px; border-radius:12px; width:100%;
  }
  .total{
    margin-left:auto; background:#0b153a; border:1px solid var(--line); border-radius:12px;
    padding:6px 12px; font-variant-numeric:tabular-nums; font-weight:900; font-size:24px;
  }
  .bump{animation:bump .35s ease}
  @keyframes bump{0%{transform:scale(1)}35%{transform:scale(1.12)}100%{transform:scale(1)}}

  /* Leaderboard */
  .lb{
    position:sticky; top:14px;
    max-height: calc(100dvh - 28px);  /* desktop/tablet fit */
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  .lb .title{display:flex; align-items:center; justify-content:space-between; margin:0 0 10px}
  .lb h3{font-size:22px; margin:0}
  .lb table{width:100%; border-collapse:collapse; font-variant-numeric:tabular-nums; table-layout:fixed}
  .lb th, .lb td{padding:14px 12px; border-bottom:1px solid #22306b; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .lb th{color:var(--muted); font-weight:900; letter-spacing:.3px; font-size:14px}
  .lb .pos{width:56px; text-align:center; font-weight:900; font-size:18px}
  .lb .name{font-weight:900; font-size:20px; letter-spacing:.2px}
  .lb .score{font-weight:900; font-size:28px; text-align:right}
  .row{transition:background-color .3s ease}
  .rise{background:#14381f} .fall{background:#3a1420}
  .blink{animation:blink .8s ease 2} @keyframes blink{50%{filter:brightness(1.4)}}

  /* Mobile behavior: leaderboard is part of flow, collapsed to top 3 by default */
  #toggleLB{display:none}                /* hidden on desktop */
  @media (max-width:980px){
    .lb{position:static; max-height:none; overflow:visible}
    #toggleLB{display:inline-block}
    .lb.collapsed tbody tr:nth-child(n+4){display:none}
  }

  .winner{position:fixed; inset:0; display:none; place-items:center; background:#0a1030cc; backdrop-filter:blur(2px)}
  .winner.show{display:grid}
  .winner .modal{background:#0f1b48; border:1px solid var(--line); border-radius:16px; padding:16px 16px 12px; max-width:min(92vw,420px)}
  .winner h2{margin:0 0 6px}

  .small{font-size:13px; color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header class="card">
    <div class="cluster">
      <div class="title">Rummy 500 üÉè</div>
      <span class="pill">üéØ Target:
        <input id="targetInput" type="number" min="100" step="10" value="500" title="Winning total" />
      </span>
      <span class="pill">üë• Players: <span id="playerCount">0</span></span>
      <span class="pill">üñêÔ∏è Hands: <span id="handCount">0</span></span>
    </div>
    <div class="cluster">
      <button id="addPlayerBtn">‚ûï Add player</button>
      <button id="undoBtn">‚§∫ Undo</button>
      <button id="newBtn">üÜï New game</button>
      <button id="exportBtn" title="Copy JSON to clipboard">üì§ Export</button>
      <button id="importBtn" title="Paste JSON to load">üì• Import</button>
    </div>
  </header>

  <main class="grid">
    <section class="players" id="players"></section>

    <aside class="card lb" id="leaderboardCard">
      <div class="title">
        <h3>Live Leaderboard ‚ô†Ô∏è‚ô•Ô∏è‚ô¶Ô∏è‚ô£Ô∏è</h3>
        <div class="cluster">
          <span class="pill" style="font-weight:800; font-size:12px">auto-updates</span>
          <button id="toggleLB" class="pill" title="Show or collapse on mobile">Show all</button>
        </div>
      </div>
      <table id="leaderboard" aria-label="Leaderboard">
        <thead><tr><th class="pos">#</th><th>Player</th><th class="score">Score</th></tr></thead>
        <tbody></tbody>
      </table>
      <p class="small" style="margin-top:10px">Top three show medals. Ties share positions.</p>
    </aside>
  </main>
</div>

<div class="winner" id="winner">
  <div class="modal card">
    <h2 id="winnerTitle"></h2>
    <p class="small">First to reach or exceed the target wins.</p>
    <div class="cluster" style="justify-content:flex-end">
      <button id="continueBtn">Continue playing</button>
      <button id="resetBtn">Reset totals</button>
    </div>
  </div>
</div>

<canvas id="fx" style="position:fixed; inset:0; pointer-events:none;"></canvas>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const must = id => { const el = document.getElementById(id); if(!el) console.error('Missing element:', id); return el; };
  const $players = must('players');
  const $playerCount = must('playerCount');
  const $handCount = must('handCount');
  const $target = must('targetInput');
  const $winner = must('winner');
  const $winnerTitle = must('winnerTitle');
  const $lbBody = document.querySelector('#leaderboard tbody');
  const $lbCard = must('leaderboardCard');
  const $toggleLB = must('toggleLB');
  const $fx = must('fx');
  if(!$players || !$lbBody) return;

  const SUITS = ['‚ô†Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','‚ô£Ô∏è','üÉè'];
  const LS_KEY = 'rummy500_state_v5_mobilelb';
  let state = { target:500, players:[], history:[], hands:0, locked:false };
  let prevRanks = new Map();

  const uid = () => Math.random().toString(36).slice(2,9);
  const clampInt = (v,min,max) => Math.max(min, Math.min(max, isFinite(v)?v:min));
  const ask = (m,d='') => prompt(m,d??'');
  const initials = n => n.trim().split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||'').join('') || 'P';
  const stableSort = (a,cmp)=>a.map((v,i)=>[v,i]).sort((x,y)=>cmp(x[0],y[0])||x[1]-y[1]).map(p=>p[0]);
  const escapeHtml = s => String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const save=()=>localStorage.setItem(LS_KEY, JSON.stringify(state));
  const load=()=>{ try{ const r=localStorage.getItem(LS_KEY); if(r){ const o=JSON.parse(r); if(o&&o.players) state={...state,...o}; } }catch{} };

  function ensureSuits(){ for(const p of state.players){ if(!p.suit){ p.suit = SUITS[(Math.random()*SUITS.length)|0]; } } }

  function addPlayer(name){
    state.players.push({id:uid(), name:name||`Player ${state.players.length+1}`, total:0, suit: SUITS[state.players.length%SUITS.length]});
    save(); render();
  }
  function addPlayerPrompt(){ const n=ask('Player name:',''); if(n!==null && n.trim()) addPlayer(n.trim()); }
  function removePlayer(id){
    if(!confirm('Remove this player?')) return;
    state.players = state.players.filter(p=>p.id!==id);
    state.history = state.history.filter(h=>h.pid!==id);
    save(); render();
  }
  function renamePlayer(id, name){
    const p = state.players.find(p=>p.id===id); if(!p) return;
    p.name = name.trim()||p.name;
    state.history.forEach(h=>{ if(h.pid===id) h.name=p.name; });
    save(); render();
  }
  function addScore(pid, delta, note){
    if(state.locked){ alert('Game finished. Continue or reset to keep scoring.'); return; }
    delta = Number(delta); if(!isFinite(delta)) return;
    const p = state.players.find(x=>x.id===pid); if(!p) return;

    const before = currentRanks();
    p.total += delta;
    state.history.unshift({id:uid(), ts:Date.now(), pid, name:p.name, delta, totalAfter:p.total, note:(note||'').trim()});
    recomputeHands(); save(); render();

    const totalEl = document.querySelector(`[data-id="${pid}"] .total`);
    if(totalEl){ totalEl.classList.remove('bump'); void totalEl.offsetWidth; totalEl.classList.add('bump'); }

    const after = currentRanks();
    const rB = before.get(pid), rA = after.get(pid);
    if(rB && rA && rB!==rA) flashRow(pid, rA<rB?'rise':'fall');
    prevRanks = after; checkWinner();
  }
  function undo(){
    const last = state.history.shift(); if(!last) return;
    const p = state.players.find(x=>x.id===last.pid); if(p) p.total -= last.delta;
    recomputeHands(); save(); render(); prevRanks = currentRanks();
  }
  function recomputeHands(){
    let count=0, seen=new Set();
    for(const h of [...state.history].reverse()){
      seen.add(h.pid);
      if(seen.size>=state.players.length && state.players.length>0){ count++; seen.clear(); }
    }
    state.hands = count;
  }
  function newGame(){
    if(!confirm('Start a new game? This clears totals and history.')) return;
    state.history=[]; state.players.forEach(p=>p.total=0); state.hands=0; state.locked=false;
    save(); render(); prevRanks = currentRanks();
  }
  function resetTotals(){
    state.history=[]; state.players.forEach(p=>p.total=0); state.hands=0; state.locked=false;
    save(); render(); prevRanks = currentRanks();
  }
  function checkWinner(){
    const tgt = state.target||500;
    const winners = state.players.filter(p=>p.total>=tgt);
    if(winners.length){
      const top = winners.sort((a,b)=>b.total-a.total)[0];
      $winnerTitle.textContent = `üèÜ ${top.name} wins with ${top.total} points`;
      state.locked = true; $winner.classList.add('show'); save();
      confetti(1100);
    }
  }

  function render(){
    $playerCount.textContent = state.players.length;
    $handCount.textContent = state.hands;
    $target.value = state.target;

    $players.innerHTML = '';
    const max = Math.max(0, ...state.players.map(p=>p.total));
    state.players.forEach(p=>{
      const card = document.createElement('div');
      card.dataset.id = p.id;
      card.className = 'card player' + (p.total===max && max>0 ? ' leader' : '');
      card.innerHTML = `
        <header>
          <div class="avatar" aria-hidden="true">${p.suit}<span class="chip">${initials(p.name)}</span></div>
          <div class="nameBlock">
            <input type="text" value="${escapeHtml(p.name)}" aria-label="Player name" />
            <span class="small" style="margin-top:2px; color:var(--muted)">Edit name if needed</span>
          </div>
          <div class="total" title="Total">${p.total}</div>
        </header>
        <div class="controls">
          <input class="delta" type="number" step="1" placeholder="+/- points" />
          <input class="note" type="text" placeholder="note (optional)" />
          <button class="addBtn">Add</button>
          <span class="quick">
            <button data-q="50">+50</button>
            <button data-q="25">+25</button>
            <button data-q="10">+10</button>
            <button data-q="5">+5</button>
            <button data-q="-5">‚àí5</button>
            <button data-q="-10">‚àí10</button>
          </span>
          <button class="rm danger" title="Remove player">Remove</button>
        </div>
      `;
      const nameInput = card.querySelector('input[type="text"]');
      nameInput.onchange = () => renamePlayer(p.id, nameInput.value);
      card.querySelector('.addBtn').onclick = () => {
        const d = card.querySelector('.delta'), n = card.querySelector('.note');
        if(d.value==='') return; addScore(p.id, Number(d.value), n.value); d.value=''; n.value='';
      };
      card.querySelectorAll('[data-q]').forEach(btn=>{ btn.onclick = () => addScore(p.id, Number(btn.dataset.q), ''); });
      card.querySelector('.rm').onclick = () => removePlayer(p.id);
      $players.appendChild(card);
    });

    renderLeaderboard();
  }

  function standings(){
    const arr = stableSort([...state.players], (a,b)=> b.total - a.total);
    let rank=0, last=null, seen=0;
    return arr.map(p=>{ seen++; if(last===null||p.total!==last){ rank=seen; last=p.total; } return {rank,...p}; });
  }
  function currentRanks(){ const m=new Map(); for(const s of standings()) m.set(s.id,s.rank); return m; }

  function renderLeaderboard(){
    const rows = standings();
    $lbBody.innerHTML='';
    rows.forEach(s=>{
      const tr = document.createElement('tr'); tr.className='row';
      const before = prevRanks.get(s.id);
      if(before){ if(s.rank<before) tr.classList.add('rise'); else if(s.rank>before) tr.classList.add('fall'); }
      const suit = (state.players.find(p=>p.id===s.id)?.suit) || '';
      tr.innerHTML = `
        <td class="pos">${s.rank<=3?['','ü•á','ü•à','ü•â'][s.rank]:s.rank}</td>
        <td class="name"><span class="suit">${suit}</span>${escapeHtml(s.name)}</td>
        <td class="score">${s.total}</td>`;
      $lbBody.appendChild(tr);
      if(before && before!==s.rank){ tr.classList.add('blink'); setTimeout(()=>tr.classList.remove('blink'),800); }
    });
    prevRanks = currentRanks();
  }

  function flashRow(pid, cls){
    const idx = standings().findIndex(x=>x.id===pid);
    const tr = $lbBody.children[idx]; if(!tr) return;
    tr.classList.remove('rise','fall'); tr.offsetWidth; tr.classList.add(cls);
    setTimeout(()=>tr.classList.remove(cls),800);
  }

  /* Confetti */
  function confetti(ms=1000){
    const ctx = $fx.getContext('2d');
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio||1));
    const resize = ()=>{ $fx.width = innerWidth*dpr; $fx.height = innerHeight*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); };
    resize(); let t0=null; const N=90;
    const parts = Array.from({length:N},(_,i)=>({
      x: innerWidth/2, y: innerHeight*0.25, vx: (Math.random()*2-1)*4, vy: Math.random()*-3-1,
      g: 0.12, s: 6+Math.random()*6, r: Math.random()*Math.PI, vr:(Math.random()*2-1)*0.2,
      c: ['#5dd39e','#ffd166','#ff6b6b','#8ab6ff','#c4a1ff'][i%5]
    }));
    function step(t){
      if(!t0) t0=t; const dt=Math.min((t-t0)/16,2); t0=t;
      ctx.clearRect(0,0,innerWidth,innerHeight);
      for(const p of parts){
        p.vy += 0.12*dt; p.x += p.vx*dt; p.y += p.vy*dt; p.r += p.vr*dt;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.fillStyle=p.c; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
        ctx.restore();
      }
      if(t - (performance.now()-ms) < ms) requestAnimationFrame(step);
      else ctx.clearRect(0,0,innerWidth,innerHeight);
    }
    requestAnimationFrame(step); window.addEventListener('resize', resize, {once:true});
  }

  /* Mobile leaderboard toggle */
  function isMobile(){ return window.matchMedia('(max-width: 980px)').matches; }
  function applyLBMode(){
    if(isMobile()){
      if(!$lbCard.classList.contains('collapsed')) $lbCard.classList.add('collapsed');
      $toggleLB.textContent = $lbCard.classList.contains('collapsed') ? 'Show all' : 'Show top 3';
      $toggleLB.style.display = 'inline-block';
    }else{
      $lbCard.classList.remove('collapsed');
      $toggleLB.style.display = 'none';
    }
  }
  $toggleLB.onclick = () => { $lbCard.classList.toggle('collapsed'); $toggleLB.textContent = $lbCard.classList.contains('collapsed') ? 'Show all' : 'Show top 3'; };
  window.addEventListener('resize', applyLBMode);

  // Wire buttons
  const w = id => must(id);
  w('addPlayerBtn').onclick = addPlayerPrompt;
  w('undoBtn').onclick = undo;
  w('newBtn').onclick = newGame;
  w('exportBtn').onclick = ()=>{ navigator.clipboard?.writeText(JSON.stringify(state,null,2)); alert('State copied to clipboard.'); };
  w('importBtn').onclick = ()=>{
    const raw = prompt('Paste previously exported JSON:',''); if(!raw) return;
    try{ const o=JSON.parse(raw); if(!o.players) throw 0; state={...state,...o}; ensureSuits(); save(); render(); prevRanks=currentRanks(); }
    catch{ alert('Invalid JSON.'); }
  };
  w('continueBtn').onclick = ()=>{ state.locked=false; $winner.classList.remove('show'); save(); render(); };
  w('resetBtn').onclick = ()=>{ resetTotals(); $winner.classList.remove('show'); };
  $target.onchange = ()=>{ state.target = clampInt(parseInt($target.value||'500'),100,5000); $target.value=state.target; save(); checkWinner(); render(); };

  // Boot
  load(); ensureSuits();
  if(state.players.length===0){ addPlayer('Player 1'); addPlayer('Player 2'); } else { render(); }
  prevRanks = currentRanks();
  checkWinner();
  applyLBMode();

  // Enter key adds score for focused player
  document.addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const a=document.activeElement;
      if(a && a.classList.contains('delta')) a.closest('.player')?.querySelector('.addBtn')?.click();
    }
  });
});
</script>
</body>
</html>
